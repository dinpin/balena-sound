# PipeWire configuration for balena-sound

context.properties = {
    # Basic properties
    core.daemon = true
    core.name = pipewire-0
    
    # Set default sample rate and format
    default.clock.rate = 48000
    default.clock.allowed-rates = [ 44100 48000 88200 96000 ]
    default.clock.quantum = 1024
    default.clock.min-quantum = 32
    default.clock.max-quantum = 8192
    
    # Memory settings
    mem.warn-mlock = false
    mem.allow-mlock = true
    
    # Module loading settings
    module.access = true
    module.x11.bell = false
}

context.spa-libs = {
    audio.convert.* = audioconvert/libspa-audioconvert
    api.alsa.* = alsa/libspa-alsa
    support.* = support/libspa-support
}

context.modules = [
    # Basic modules
    { name = libpipewire-module-protocol-native }
    { name = libpipewire-module-profiler }
    { name = libpipewire-module-metadata }
    { name = libpipewire-module-spa-device-factory }
    { name = libpipewire-module-spa-node-factory }
    { name = libpipewire-module-client-node }
    { name = libpipewire-module-client-device }
    { name = libpipewire-module-adapter }
    { name = libpipewire-module-link-factory }
    { name = libpipewire-module-session-manager }
    
    # RT module for better latency
    {
        name = libpipewire-module-rt
        args = {
            nice.level = -11
            rt.prio = 88
            rt.time.soft = 2000000
            rt.time.hard = 2000000
        }
        flags = [ ifexists nofail ]
    }
    
    # Protocol for PulseAudio compatibility
    {
        name = libpipewire-module-protocol-pulse
        args = {
            server.address = [
                "unix:native"
                "tcp:0.0.0.0:4317"  # Listen on all interfaces for container networking
            ]
            pulse.min.req = 256/48000
            pulse.default.req = 960/48000
            pulse.max.req = 1024/48000
            pulse.min.quantum = 256/48000
            pulse.max.quantum = 1024/48000
        }
    }
]

context.objects = [
    # ALSA support
    {
        factory = spa-node-factory
        args = {
            factory.name = support.node.driver
            node.name = Dummy-Driver
            node.group = pipewire.dummy
            priority.driver = 20000
        }
    }
    
    # Create metadata object
    {
        factory = metadata
        args = {
            metadata.name = default
            metadata.values = [
                { key = default.audio.sink value = { name = balena-sound.input } }
            ]
        }
    }
]

context.exec = []
