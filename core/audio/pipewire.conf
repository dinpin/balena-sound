# PipeWire configuration for balena-sound
# Simplified configuration to avoid conflicts

context.properties = {
    default.clock.rate = 48000
    default.clock.quantum = 1024
    default.clock.min-quantum = 32
    default.clock.max-quantum = 2048
    
    # Disable session bus for container environment
    core.daemon = true
    core.name = pipewire-0
}

context.spa-libs = {
    audio.convert.* = audioconvert/libspa-audioconvert
    support.* = support/libspa-support
}

context.modules = [
    # Core modules - minimal set to avoid conflicts
    { name = libpipewire-module-rt
        args = {
            nice.level = -11
            rt.prio = 88
            rt.time.soft = 200000
            rt.time.hard = 200000
        }
        flags = [ ifexists nofail ]
    }
    { name = libpipewire-module-protocol-native }
    { name = libpipewire-module-client-node }
    { name = libpipewire-module-adapter }
    { name = libpipewire-module-link-factory }

    # ALSA support
    { name = libpipewire-module-spa-device
        args = {
            factory.name = api.alsa.enum.udev
            spa.device.api = alsa
        }
        flags = [ ifexists nofail ]
    }

    # PulseAudio compatibility
    { name = libpipewire-module-protocol-pulse
        args = {
            pulse.min.req = 256/48000
            pulse.default.req = 960/48000
            pulse.max.req = 8192/48000
            pulse.min.quantum = 256/48000
            pulse.max.quantum = 8192/48000
            server.address = [ "unix:native" "tcp:4317" ]
        }
    }
]

# Virtual sinks for balena-sound routing
context.objects = [
    # balena-sound.input - receives audio from plugins
    {
        factory = adapter
        args = {
            factory.name = support.null-audio-sink
            node.name = "balena-sound.input"
            node.description = "balena-sound Input Sink"
            media.class = "Audio/Sink"
            audio.format = "S24LE"
            audio.rate = 48000
            audio.channels = 2
            audio.position = [ FL FR ]
        }
    }
    
    # balena-sound.output - routes to hardware
    {
        factory = adapter
        args = {
            factory.name = support.null-audio-sink
            node.name = "balena-sound.output"
            node.description = "balena-sound Output Sink"
            media.class = "Audio/Sink"
            audio.format = "S24LE"
            audio.rate = 48000
            audio.channels = 2
            audio.position = [ FL FR ]
        }
    }
    
    # snapcast - for multiroom audio
    {
        factory = adapter
        args = {
            factory.name = support.null-audio-sink
            node.name = "snapcast"
            node.description = "Snapcast Multiroom Sink"
            media.class = "Audio/Sink"
            audio.format = "S24LE"
            audio.rate = 48000
            audio.channels = 2
            audio.position = [ FL FR ]
        }
    }
]
